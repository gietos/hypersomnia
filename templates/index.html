<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="dns-prefetch" href="//unpkg.com"/>
    <link rel="dns-prefetch" href="//use.fontawesome.com"/>
    <link rel="stylesheet" href="https://unpkg.com/bootstrap@4.3.1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/jsoneditor@6.1.0/dist/jsoneditor.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.10.1/css/all.css">
    <title>Hypersomnia</title>
    <style>
        body, html {
            margin: 0;
            height:100%;
        }

        body{
            overflow: hidden;
        }

        .container-fluid, .parent {
            height: 100%;
        }

        #services, #request, #response {
            position: relative;
            float: left;
            height:100%;
            overflow-y: auto;
        }

        div.active {
            background-color: #444444;
            color: #ffffff;
            -webkit-border-radius: 3px;
            -moz-border-radius: 3px;
            border-radius: 3px;
        }

        .ace-jsoneditor.ace_editor {
            font-size: 10px!important;
        }

        #request-editor, #response-editor {
            height: 90%;
        }
    </style>
</head>
<body>
<div class="container-fluid p-2 pl-4">

    <div class="row parent">
        <div class="col-sm" id="services">
            Environment: <select class="js-environment">
                {{range .Envs}}
                    <option value="{{.}}">{{.}}</option>
                {{end}}
            </select>
            <div class="mt-1 mb-1">
                Services:
            </div>
            <div class="js-services">

            </div>
        </div>
        <div class="col-sm" id="request">
            <div class="mb-2 clearfix">
                <div class="js-active-endpoint float-left pt-1 pb-1"></div>
                <button class="btn btn-sm btn-primary js-send float-right">Send</button>
                <button class="btn btn-sm btn-secondary js-reset float-right mr-2">Reset</button>
            </div>
            <div id="request-editor"></div>
        </div>
        <div class="col-sm" id="response">
            <div class="mb-3 mt-3 clearfix">
                <span class="badge badge-secondary js-response-time float-right">...</span>
                <span class="badge badge-secondary js-response-took float-right mr-2">...</span>
                <span class="badge badge-secondary js-correlation-id float-right mr-2" style="cursor: pointer;">...</span>
            </div>
            <div id="response-editor"></div>
        </div>
    </div>
</div>
<script src="https://unpkg.com/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://unpkg.com/popper.js@1.15.0/dist/umd/popper.min.js"></script>
<script src="https://unpkg.com/bootstrap@4.3.1/dist/js/bootstrap.min.js"></script>
<script src="https://unpkg.com/moment@2.24.0/min/moment.min.js"></script>
<script src="https://unpkg.com/jsoneditor@6.1.0/dist/jsoneditor.min.js"></script>
<script src="https://unpkg.com/dexie@2.0.4/dist/dexie.js"></script>
<script src="https://unpkg.com/jsonpath@1.0.2/jsonpath.min.js"></script>
<script src="https://unpkg.com/mustache@3.0.1/mustache.min.js"></script>
{{ .JsTemplates }}
<script>
    let tmplService = $('#tmplService').html();
    let tmplEndpoint = $('#tmplEndpoint').html();

    String.prototype.replaceAll = function(search, replacement) {
        let target = this;
        return target.replace(new RegExp(search, 'g'), replacement);
    };

    Array.prototype.remove = function() {
        var what, a = arguments, L = a.length, ax;
        while (L && this.length) {
            what = a[--L];
            while ((ax = this.indexOf(what)) !== -1) {
                this.splice(ax, 1);
            }
        }
        return this;
    };

    var copyToClipboard = function(data) {
        var tempInput = document.createElement('INPUT');
        let body = $('body')[0];
        body.appendChild(tempInput);
        tempInput.setAttribute('value', data);
        tempInput.select();
        document.execCommand('copy');
        body.removeChild(tempInput);
    };

    function pregQuote (str, delimiter) {
        return (str + '').replace(new RegExp('[.\\\\+*?\\[\\^\\]$(){}=!<>|:\\' + (delimiter || '/') + '-]', 'g'), '\\$&');
    }

    function getMatches(string) {
        let matches = [];
        let match;
        let regex = /Response\.(.+?)\((.+?),?(\s?int)?\)/g;
        while (match = regex.exec(string)) {
            matches[match[0]] = {
                endpoint: match[1],
                path: match[2],
                type: match[3] || 'string',
            };
        }
        return matches;
    }

    function pack(v) {
        let m = {};
        if (typeof v !== 'undefined' && typeof v.values !== 'undefined') {
            for (let i in v.values) {
                if(v.values[i].values == null || v.values[i].values.length == 0) {
                    if(v.values[i].type == 'string') {
                        m[v.values[i].name] = "";
                    } else {
                        m[v.values[i].name] = 0;
                    }
                } else {
                    m[v.values[i].name] = pack(v.values[i]);
                }
            }
        }
        return m
    }

    let storage = window.localStorage;

    let db = new Dexie("hypersomnia");
    db.version(1).stores({
        requests: 'endpoint,body',
        responses: 'endpoint,time,receivedAt,body,correlationId'
    });

    let activeEndpoint = storage.getItem('active-endpoint');
    let favorites = storage.getItem('favorites');
    if (favorites) {
        favorites = JSON.parse(favorites);
    } else {
        favorites = [];
    }

    $(function () {
        let requestEditor = new JSONEditor(document.getElementById("request-editor"), {
            enableSort: false,
            enableTransform: false,
            mode: 'code',
        });
        let responseEditor = new JSONEditor(document.getElementById("response-editor"), {
            mode: 'code',
        });

        $('.js-environment').on('change', function () {
            $('.js-environment').prop('disabled', true)
            $.ajax({
                method: 'POST',
                url: 'services',
                dataType: 'json',
                contentType: 'application/json',
                data: JSON.stringify({
                    environment: $(this).val(),
                }),
                success: function (response) {
                    $('.js-services').text('');
                    // Favorites
                    for (let i in response) {
                        let name = response[i].name;
                        if (favorites.indexOf(name) === -1) {
                            continue;
                        }
                        let id = name.replace(/\./g, '_');
                        $('.js-services').append(Mustache.render(tmplService, {id: id, name: name}));
                    }

                    for (let i in response) {
                        let name = response[i].name;
                        if (name === '') {
                            continue;
                        }
                        if (favorites.indexOf(name) !== -1) {
                            continue;
                        }
                        let id = name.replace(/\./g, '_');
                        $('.js-services').append(Mustache.render(tmplService, {id: id, name: name}));
                    }

                    for (let i in favorites) {
                        $('.js-favorite[data-service="'+favorites[i]+'"]')
                            .addClass('js-favorite-on')
                            .addClass('fas')
                            .removeClass('far')
                        ;
                    }

                    $('.collapse')
                        .each(function () {
                            let id = $(this).attr('id');
                            if (storage.getItem(id + ':show') === 'true') {
                                $(this).collapse('show');
                            } else {
                                $(this).collapse('hide');
                            }
                        })
                    ;
                },
                error: function () {
                    alert("AJAX error");
                },
                complete: function () {
                    $('.js-environment').prop('disabled', false)
                }
            });
        });
        $('.js-environment').trigger('change');

        $(document).on('click', '.js-endpoint-toggle', function () {
            let service = $(this).data('service');
            storage.setItem('active-service', service);

            let endpoint = $(this).data('endpoint');
            storage.setItem('active-endpoint', endpoint);
            $('.js-active-endpoint').text(endpoint);
            $('.js-endpoint-toggle').removeClass('active');
            $(this).addClass('active');

            let requestBody = JSON.parse($(this).find('.js-endpoint-request-template').text());
            requestEditor.set('loading...');
            db.requests.where('endpoint').equals(endpoint).first().then(function(request) {
                if (request) {
                    requestBody = request.body;
                }
            }).catch(function(error){
                console.log(error);
            }).finally(function () {
                requestEditor.set(requestBody);
            });

            responseEditor.set('loading...');
            $('.js-response-took').text('...');
            $('.js-response-time').text('...');
            $('.js-correlation-id').text('');

            let cachedResponse = {
                time: '...',
                receivedAt: '',
                body: '',
                correlationId: '',
            };
            db.responses.where('endpoint').equals(endpoint).first().then(function(response) {
                if (response) {
                    cachedResponse = response;
                }
            }).catch(function(error){
                console.log(error);
            }).finally(function () {
                responseEditor.set(cachedResponse.body);
                $('.js-response-took').text(cachedResponse.time);
                $('.js-response-time').text(moment(cachedResponse.receivedAt).fromNow());
                $('.js-correlation-id').text(cachedResponse.correlationId);
            });
        });

        $(document).on('keyup', '#request-editor', function () {
            let endpoint = storage.getItem('active-endpoint');
            db.requests.put({endpoint: endpoint, body: requestEditor.get()});
        });

        $(document).on('click', '.js-reset', function () {
            let endpoint = storage.getItem('active-endpoint');
            let requestTemplate = $('.js-endpoint-toggle[data-endpoint="'+endpoint+'"]').find('.js-endpoint-request-template').text();
            requestEditor.set(JSON.parse(requestTemplate));
        });

        $(document)
            .on('show.bs.collapse', '.collapse', function () {
                let id = $(this).attr('id');
                storage.setItem(id + ':show', true);
                let serviceName = $(this).data('service');
                let container = $('.js-endpoints[id="'+id+'"]');
                container.html('loading...');
                $.ajax({
                    method: 'POST',
                    url: 'service',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        environment: $('.js-environment').val(),
                        name: serviceName,
                    }),
                    success: function (response) {
                        container.html('<ul class="list-unstyled"></ul>');
                        for (let i in response.endpoints) {
                            container.find('ul').append(Mustache.render(tmplEndpoint, {
                                serviceName: serviceName,
                                endpointName: response.endpoints[i].name,
                                requestTemplate: JSON.stringify(pack(response.endpoints[i].request)),
                            }));
                        }
                        if (activeEndpoint) {
                            $('.js-endpoint-toggle[data-endpoint="' + activeEndpoint + '"]').trigger('click');
                        }
                    },
                    error: function () {
                        alert("AJAX error");
                    },
                    complete: function () {
                    }
                });
            })
            .on('hide.bs.collapse', '.collapse', function () {
                let id = $(this).attr('id');
                storage.setItem(id + ':show', false);
            })
        ;
        $('.collapse')
            .each(function () {
                let id = $(this).attr('id');
                if (storage.getItem(id + ':show') === 'true') {
                    $(this).collapse('show');
                } else {
                    $(this).collapse('hide');
                }
            })
        ;

        $(document).on('click', '.js-send', function () {
            $('.js-send').prop('disabled', true);
            let environment = $('.js-environment').val();
            let service = storage.getItem('active-service');
            let endpoint = storage.getItem('active-endpoint');
            let body;
            try {
                body = requestEditor.get();
            } catch (e) {
                alert('Request: ' + e.message);
            }

            responseEditor.set('loading...')
            $('.js-response-time').text('...');
            $('.js-response-took').text('...');
            $('.js-correlation-id').text('...');

            let bodyText = JSON.stringify(body);
            let matches = getMatches(bodyText);

            let promises = [];
            for (let match in matches) {
                let source = matches[match];
                let replace = '';

                promises.push(db.responses.where('endpoint').equals(source.endpoint).first().then(function(response) {
                    if (response) {
                        replace = jsonpath.value(response.body, source.path);
                    }
                }).catch(function(error){
                    console.log(error);
                }).finally(function () {
                    if (source.type === 'int') {
                        match = '"' + match + '"';
                    }
                    bodyText = bodyText.replaceAll(pregQuote(match), replace);
                }));
            }

            Promise.all(promises).then(function() {
                body = JSON.parse(bodyText);
                console.log('Environment: ' + environment + '\nService: ' + service + '\nEndpoint: ' + endpoint + '\nRequest: ' + JSON.stringify(body));
                $.ajax({
                    method: 'POST',
                    url: 'call',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        environment: environment,
                        service: service,
                        endpoint: endpoint,
                        body: body,
                    }),
                    success: function (response) {
                        let body;
                        try {
                            body = JSON.parse(response.Body);
                        } catch (e) {
                            body = response.Body;
                        }

                        $('.js-response-time').text('just now');
                        $('.js-response-took').text(response.Time);
                        $('.js-correlation-id').text(response.CorrelationId);
                        responseEditor.set(body);

                        db.responses.put({
                            endpoint: endpoint,
                            receivedAt: moment().format(),
                            time: response.Time,
                            body: body,
                            correlationId: response.CorrelationId,
                        });
                    },
                    error: function () {
                        alert("AJAX error");
                    },
                    complete: function () {
                        $('.js-send').prop('disabled', false);
                    }
                });
            });
        });

        $(document).on('click', '.js-favorite', function() {
            let service = $(this).data('service');
            if (favorites.indexOf(service) === -1) {
                favorites.push(service);
                storage.setItem('favorites', JSON.stringify(favorites));
                let serviceContainer = $(this).parent();
                serviceContainer.parent().prepend(serviceContainer);
            }
            $(this)
                .addClass('js-favorite-on')
                .removeClass('far')
                .addClass('fas')
            ;
        });

        $(document).on('click', '.js-favorite-on', function() {
            let service = $(this).data('service');
            favorites.remove(service);
            storage.setItem('favorites', JSON.stringify(favorites));
            $(this)
                .removeClass('js-favorite-on')
                .removeClass('fas')
                .addClass('far')
            ;
            let serviceContainer = $(this).parent();
            serviceContainer.parent().append(serviceContainer);
        });

        $('#request-editor').keydown(function (e) {
            if (e.ctrlKey && e.keyCode === 13) {
                $('.js-send').trigger('click');
            }
        });

        $(document).on('click', '.js-correlation-id', function () {
            copyToClipboard($(this).text());
            $(this).tooltip('dispose');
            $(this).tooltip({title: 'Copied!'}).tooltip('show');
        });
        $(document).on('mouseleave', '.js-correlation-id', function () {
            $(this).tooltip('dispose');
            $(this).tooltip({title: 'Copy to clipboard'});
        });
        $('.js-correlation-id').tooltip({ title: 'Copy to clipboard' });

        if (activeEndpoint) {
            $('.js-endpoint-toggle[data-endpoint="' + activeEndpoint + '"]').trigger('click');
        }
    });
</script>
</body>
</html>
